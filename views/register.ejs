<%- include('partials/header')%>

	<div class="container mt-5">
		<div class="row justify-content-center">
			<div class="col-md-8 col-lg-6">
				<div class="card shadow">
					<div class="card-header bg-success text-white text-center">
						<h4 class="mb-0">
							<i class="fas fa-user-plus"></i> Kayıt Ol
						</h4>
					</div>
					<div class="card-body">
						<!-- Error Message -->
						<div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

						<!-- Success Message -->
						<div id="successMessage" class="alert alert-success" style="display: none;"></div>

						<!-- Register Form -->
						<form id="registerForm">
							<div class="row">
								<div class="col-md-6 mb-3">
									<label for="name" class="form-label">
										<i class="fas fa-user"></i> Ad
									</label>
									<input type="text" class="form-control" id="name" name="name"
										placeholder="Adınızı giriniz" required minlength="2" maxlength="50">
								</div>

								<div class="col-md-6 mb-3">
									<label for="surname" class="form-label">
										<i class="fas fa-user"></i> Soyad
									</label>
									<input type="text" class="form-control" id="surname" name="surname"
										placeholder="Soyadınızı giriniz" required minlength="2" maxlength="50">
								</div>
							</div>

							<div class="mb-3">
								<label for="phoneNumber" class="form-label">
									<i class="fas fa-phone"></i> Telefon Numarası
								</label>
								<input type="tel" class="form-control" id="phoneNumber" name="phoneNumber"
									placeholder="5551234567" required maxlength="11">
								<div class="form-text">
									Telefon numaranızı başında 0 olmadan giriniz (10-11 hane)
								</div>
							</div>

							<div class="mb-3">
								<label for="password" class="form-label">
									<i class="fas fa-lock"></i> Şifre
								</label>
								<div class="input-group">
									<input type="password" class="form-control" id="password" name="password"
										placeholder="Şifrenizi giriniz" required minlength="6">
									<button class="btn btn-outline-secondary" type="button" id="togglePassword">
										<i class="fas fa-eye" id="eyeIcon"></i>
									</button>
								</div>
								<div class="form-text">
									Şifreniz en az 6 karakter olmalıdır
								</div>
							</div>

							<div class="mb-3">
								<label for="confirmPassword" class="form-label">
									<i class="fas fa-lock"></i> Şifre Tekrar
								</label>
								<div class="input-group">
									<input type="password" class="form-control" id="confirmPassword"
										name="confirmPassword" placeholder="Şifrenizi tekrar giriniz" required
										minlength="6">
									<button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
										<i class="fas fa-eye" id="eyeIcon2"></i>
									</button>
								</div>
							</div>

							<div class="mb-3 form-check">
								<input type="checkbox" class="form-check-input" id="termsCheck" required>
								<label class="form-check-label" for="termsCheck">
									<a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Kullanım
										şartlarını</a> kabul ediyorum
								</label>
							</div>

							<div class="d-grid">
								<button type="submit" class="btn btn-success" id="registerBtn">
									<span id="registerSpinner" class="spinner-border spinner-border-sm"
										style="display: none;"></span>
									<i class="fas fa-user-plus" id="registerIcon"></i>
									Kayıt Ol
								</button>
							</div>
						</form>

						<hr>

						<div class="text-center">
							<p class="mb-0">Zaten hesabınız var mı?</p>
							<a href="/login" class="btn btn-link">
								<i class="fas fa-sign-in-alt"></i> Giriş Yap
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Terms Modal -->
	<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="termsModalLabel">Kullanım Şartları</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<h6>1. Genel Kullanım</h6>
					<p>Bu platform berber randevu sistemi olarak hizmet vermektedir...</p>

					<h6>2. Gizlilik</h6>
					<p>Kişisel bilgileriniz güvenlik altında tutulacaktır...</p>

					<h6>3. Randevu Kuralları</h6>
					<p>Randevularınızı zamanında iptal etmeniz gerekmektedir...</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
				</div>
			</div>
		</div>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const registerForm = document.getElementById('registerForm');
			const nameInput = document.getElementById('name');
			const surnameInput = document.getElementById('surname');
			const phoneNumberInput = document.getElementById('phoneNumber');
			const passwordInput = document.getElementById('password');
			const confirmPasswordInput = document.getElementById('confirmPassword');
			const togglePasswordBtn = document.getElementById('togglePassword');
			const toggleConfirmPasswordBtn = document.getElementById('toggleConfirmPassword');
			const eyeIcon = document.getElementById('eyeIcon');
			const eyeIcon2 = document.getElementById('eyeIcon2');
			const registerBtn = document.getElementById('registerBtn');
			const registerSpinner = document.getElementById('registerSpinner');
			const registerIcon = document.getElementById('registerIcon');
			const errorMessage = document.getElementById('errorMessage');
			const successMessage = document.getElementById('successMessage');
			const termsCheck = document.getElementById('termsCheck');

			// Toggle password visibility
			togglePasswordBtn.addEventListener('click', function () {
				togglePasswordVisibility(passwordInput, eyeIcon);
			});

			toggleConfirmPasswordBtn.addEventListener('click', function () {
				togglePasswordVisibility(confirmPasswordInput, eyeIcon2);
			});

			function togglePasswordVisibility(input, icon) {
				const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
				input.setAttribute('type', type);

				if (type === 'text') {
					icon.classList.remove('fa-eye');
					icon.classList.add('fa-eye-slash');
				} else {
					icon.classList.remove('fa-eye-slash');
					icon.classList.add('fa-eye');
				}
			}

			// Name and surname input formatting (only letters)
			[nameInput, surnameInput].forEach(input => {
				input.addEventListener('input', function () {
					this.value = this.value.replace(/[^a-zA-ZçğıöşüÇĞIİÖŞÜ\s]/g, '');
				});
			});

			// Phone number input formatting
			phoneNumberInput.addEventListener('input', function () {
				let value = this.value.replace(/\D/g, ''); // Only numbers
				if (value.startsWith('0')) {
					value = value.substring(1); // Remove leading 0
				}
				this.value = value;
			});

			// Real-time password confirmation check
			confirmPasswordInput.addEventListener('input', function () {
				if (passwordInput.value !== this.value) {
					this.setCustomValidity('Şifreler eşleşmiyor');
					this.classList.add('is-invalid');
				} else {
					this.setCustomValidity('');
					this.classList.remove('is-invalid');
					this.classList.add('is-valid');
				}
			});

			// Form submission
			registerForm.addEventListener('submit', async function (e) {
				e.preventDefault();

				const name = nameInput.value.trim();
				const surname = surnameInput.value.trim();
				const phoneNumber = phoneNumberInput.value.trim();
				const password = passwordInput.value.trim();
				const confirmPassword = confirmPasswordInput.value.trim();

				// Validation
				if (name.length < 2) {
					showError('Ad en az 2 karakter olmalıdır.');
					return;
				}

				if (surname.length < 2) {
					showError('Soyad en az 2 karakter olmalıdır.');
					return;
				}

				if (phoneNumber.length < 10) {
					showError('Telefon numarası en az 10 haneli olmalıdır.');
					return;
				}

				if (password.length < 6) {
					showError('Şifre en az 6 karakter olmalıdır.');
					return;
				}

				if (password !== confirmPassword) {
					showError('Şifreler eşleşmiyor.');
					return;
				}

				if (!termsCheck.checked) {
					showError('Kullanım şartlarını kabul etmelisiniz.');
					return;
				}

				// Show loading state
				setLoading(true);
				hideMessages();

				try {
					const response = await fetch('http://localhost:3000/profile/register/user', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							name: name,
							surname: surname,
							phoneNumber: phoneNumber,
							password: password
						})
					});

					const data = await response.json();

					if (response.ok) {
						// Registration successful
						showSuccess('Kayıt başarılı! Giriş sayfasına yönlendiriliyorsunuz...');

						// Reset form
						registerForm.reset();

						// Redirect to login page after 3 seconds
						setTimeout(() => {
							window.location.href = '/login';
						}, 3000);

					} else {
						// Registration failed
						showError(data.message || 'Kayıt başarısız. Lütfen bilgilerinizi kontrol edin.');
					}

				} catch (error) {
					console.error('Register error:', error);
					showError('Bağlantı hatası. Lütfen daha sonra tekrar deneyin.');
				} finally {
					setLoading(false);
				}
			});

			function setLoading(loading) {
				if (loading) {
					registerBtn.disabled = true;
					registerSpinner.style.display = 'inline-block';
					registerIcon.style.display = 'none';
				} else {
					registerBtn.disabled = false;
					registerSpinner.style.display = 'none';
					registerIcon.style.display = 'inline-block';
				}
			}

			function showError(message) {
				errorMessage.textContent = message;
				errorMessage.style.display = 'block';
				successMessage.style.display = 'none';

				// Scroll to top to show error
				window.scrollTo({ top: 0, behavior: 'smooth' });
			}

			function showSuccess(message) {
				successMessage.textContent = message;
				successMessage.style.display = 'block';
				errorMessage.style.display = 'none';

				// Scroll to top to show success
				window.scrollTo({ top: 0, behavior: 'smooth' });
			}

			function hideMessages() {
				errorMessage.style.display = 'none';
				successMessage.style.display = 'none';
			}
		});
	</script>

	<%- include('partials/footer')%>