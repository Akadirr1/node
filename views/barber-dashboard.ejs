<%- include('partials/header')%>

	<div class="dashboard-container">
		<div class="container-fluid">
			<div class="dashboard-header">
				<h1 class="dashboard-title">Berber Yönetim Paneli</h1>
				<div class="welcome-message">
					<span id="welcomeMessage">Hoş geldiniz!</span>
				</div>
			</div>

			<%- include('sections/appointments') %>

			<%- include('sections/services') %>

			<%- include('sections/timeoffs') %>

			<%- include('sections/availability') %>

			<!-- Add Service Modal -->
			<div id="addServiceModal" class="modal" style="display: none;">
				<div class="modal-content">
					<div class="modal-header">
						<h3>Yeni Hizmet Ekle</h3>
						<span class="close" onclick="hideAddServiceModal()">&times;</span>
					</div>
					<div class="modal-body">
						<form id="addServiceForm">
							<div class="form-group">
								<label for="serviceSelect">Hizmet Türü:</label>
								<select id="serviceSelect" required>
									<option value="">Hizmet seçiniz...</option>
								</select>
							</div>
							<div class="form-group">
								<label for="servicePrice">Fiyat (₺):</label>
								<input type="number" id="servicePrice" min="0" step="0.01" required>
							</div>
							<div class="form-group">
								<label for="serviceDuration">Süre (dakika):</label>
								<input type="number" id="serviceDuration" min="1" step="1" required>
							</div>
							<div class="form-actions">
								<button type="button" class="cancel-btn-modal" onclick="hideAddServiceModal()">İptal</button>
								<button type="submit" class="save-btn">Ekle</button>
							</div>
						</form>
					</div>
				</div>
			</div>

			<!-- Edit Service Modal -->
			<div id="editServiceModal" class="modal" style="display: none;">
				<div class="modal-content">
					<div class="modal-header">
						<h3>Hizmet Düzenle</h3>
						<span class="close" onclick="hideEditServiceModal()">&times;</span>
					</div>
					<div class="modal-body">
						<form id="editServiceForm">
							<div class="form-group">
								<label for="editServiceName">Hizmet Adı:</label>
								<input type="text" id="editServiceName" readonly style="background-color: #2a2a2a; color: #888;">
							</div>
							<div class="form-group">
								<label for="editServicePrice">Fiyat (₺):</label>
								<input type="number" id="editServicePrice" min="0" step="0.01" required>
							</div>
							<div class="form-group">
								<label for="editServiceDuration">Süre (dakika):</label>
								<input type="number" id="editServiceDuration" min="1" step="1" required>
							</div>
							<div class="form-actions">
								<button type="button" class="cancel-btn-modal" onclick="hideEditServiceModal()">İptal</button>
								<button type="submit" class="save-btn">Güncelle</button>
							</div>
						</form>
					</div>
				</div>
			</div>

			<!-- Add Time Off Modal -->
			<div id="addTimeOffModal" class="modal time-off-modal" style="display: none;">
				<div class="modal-content">
					<div class="modal-header">
						<h3>İzin Ekle</h3>
						<span class="close" onclick="hideAddTimeOffModal()">&times;</span>
					</div>
					<div class="modal-body">
						<form id="addTimeOffForm">
							<div class="form-group">
								<label class="form-label">Tarih Aralığı</label>
								<div class="date-range-container">
									<div class="date-input-group">
										<label for="timeOffStartDate">Başlangıç Tarihi</label>
										<input type="date" id="timeOffStartDate" required>
									</div>
									<div class="date-input-group">
										<label for="timeOffEndDate">Bitiş Tarihi</label>
										<input type="date" id="timeOffEndDate" required>
									</div>
								</div>
							</div>

							<div class="form-group">
								<label class="form-label">Saat Aralığı</label>
								<div class="timeoff-time-selection">
									<div class="time-group">
										<label for="timeoff-start-time">Başlangıç Saati</label>
										<input type="text" id="timeoff-start-time" class="time-picker" placeholder="09:00" readonly>
									</div>
									<div class="time-group">
										<label for="timeoff-end-time">Bitiş Saati</label>
										<input type="text" id="timeoff-end-time" class="time-picker" placeholder="17:00" readonly>
									</div>
								</div>
								<div class="time-info">
									<small>Flatpickr ile saat seçimi yapılabilir</small>
								</div>
							</div>

							<div class="form-group">
								<label for="timeOffReason">İzin Sebebi:</label>
								<textarea id="timeOffReason" rows="3" placeholder="İzin sebebinizi yazın..." required></textarea>
							</div>

							<div class="form-actions">
								<button type="button" class="cancel-btn-modal" onclick="hideAddTimeOffModal()">İptal</button>
								<button type="submit" class="save-btn">İzin Ekle</button>
							</div>
						</form>
					</div>
				</div>
			</div>

			<!-- Add Appointment Modal -->
			<div id="addAppointmentModal" class="modal appointment-modal" style="display: none;">
				<div class="modal-content">
					<div class="modal-header">
						<h3>Manuel Randevu Ekle</h3>
						<span class="close" onclick="hideAddAppointmentModal()">&times;</span>
					</div>
					<div class="modal-body">
						<form id="addAppointmentForm">
							<!-- Customer Type Selection -->
							<div class="customer-type-tabs">
								<button type="button" id="registeredTab" class="tab-btn active" onclick="switchCustomerType('registered')">
									Kayıtlı Müşteri
								</button>
								<button type="button" id="guestTab" class="tab-btn" onclick="switchCustomerType('guest')">
									Misafir Müşteri
								</button>
							</div>

							<!-- Registered Customer Section -->
							<div id="registeredCustomerSection" class="customer-section">
								<div class="input-group">
									<label for="customerSearch">Müşteri Telefon Numarası:</label>
									<input type="tel" id="customerSearch" placeholder="5XXXXXXXXX" oninput="searchCustomers(this.value)">
									<input type="hidden" id="customerId">
									<div id="selectedCustomerInfo" class="selected-customer-info" style="display: none;"></div>
								</div>
							</div>

							<!-- Guest Customer Section -->
							<div id="guestCustomerSection" class="customer-section" style="display: none;">
								<div class="guest-info-container">
									<div class="input-group">
										<label for="guestName">Ad:</label>
										<input type="text" id="guestName" placeholder="Müşteri adı">
									</div>
									<div class="input-group">
										<label for="guestSurname">Soyad:</label>
										<input type="text" id="guestSurname" placeholder="Müşteri soyadı">
									</div>
									<div class="input-group">
										<label for="guestPhone">Telefon:</label>
										<input type="tel" id="guestPhone" placeholder="5XXXXXXXXX">
									</div>
								</div>
							</div>

							<!-- Service and DateTime Selection -->
							<div class="input-group">
								<label for="appointmentServiceId">Hizmet:</label>
								<select id="appointmentServiceId" class="form-select" required>
									<option value="">Hizmet seçin...</option>
								</select>
							</div>

							<div class="datetime-container">
								<div class="input-group">
									<label for="appointmentDate">Tarih:</label>
									<input type="date" id="appointmentDate" required>
								</div>
								<div class="input-group">
									<label for="appointmentTime">Saat:</label>
									<input type="text" id="appointmentTime" placeholder="10:00" readonly required>
								</div>
							</div>

							<div class="form-actions">
								<button type="button" class="cancel-btn-modal" onclick="hideAddAppointmentModal()">İptal</button>
								<button type="submit" class="save-btn">Randevu Oluştur</button>
							</div>
						</form>
					</div>
				</div>
			</div>

			<!-- Day Appointments Modal -->
			<div id="dayAppointmentsModal" class="modal day-appointments-modal" style="display: none;">
				<div class="modal-content">
					<div class="modal-header">
						<h3 id="modalDateTitle">Günlük Randevular</h3>
						<span class="close" onclick="closeDayAppointmentsModal()">&times;</span>
					</div>
					<div class="modal-body">
						<div id="dayAppointmentsList" class="day-appointments-list"></div>
						<div id="noDayAppointments" class="no-day-appointments" style="display: none;">
							<i class="fas fa-calendar-day"></i>
							<p>Bu günde henüz randevu bulunmamaktadır.</p>
						</div>
					</div>
				</div>
			</div>

		</div>
	</div>

	<style>
		.dashboard-container {
			background-color: #1a1a1a;
			min-height: 100vh;
			padding: 60px 0;
		}

		.dashboard-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 40px;
			padding: 0 40px;
		}

		.dashboard-title {
			color: #8bc34a;
			font-size: 36px;
			font-weight: 600;
			margin: 0;
		}

		.welcome-message {
			color: #ffffff;
			font-size: 18px;
		}

		.section-title {
			color: #ffffff;
			font-size: 24px;
			font-weight: 600;
			margin-bottom: 30px;
		}

		.error-message {
			background: #ff4444;
			color: white;
			padding: 15px;
			border-radius: 8px;
			text-align: center;
			margin: 20px 0;
		}

		.spinner-border {
			color: #8bc34a;
		}

		/* Modal Styles for shared modals */
		.modal {
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.8);
			display: flex;
			justify-content: center;
			align-items: center;
		}

		.modal-content {
			background: #2d2d2d;
			border-radius: 12px;
			width: 90%;
			max-width: 500px;
			border: 1px solid #4a4a4a;
		}

		.modal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 20px 25px;
			border-bottom: 1px solid #4a4a4a;
		}

		.modal-header h3 {
			color: #8bc34a;
			margin: 0;
			font-size: 20px;
		}

		.close {
			color: #ffffff;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
			line-height: 1;
		}

		.close:hover {
			color: #8bc34a;
		}

		.modal-body {
			padding: 25px;
		}

		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			color: #ffffff;
			font-weight: 600;
			margin-bottom: 8px;
		}

		.form-group input,
		.form-group select,
		.form-group textarea {
			width: 100%;
			padding: 12px;
			border: 1px solid #4a4a4a;
			border-radius: 6px;
			background: #1a1a1a;
			color: #ffffff;
			font-size: 16px;
		}

		.form-group input:focus,
		.form-group select:focus,
		.form-group textarea:focus {
			outline: none;
			border-color: #8bc34a;
		}

		.form-group textarea {
			font-family: inherit;
			resize: vertical;
			min-height: 80px;
		}

		.form-actions {
			display: flex;
			gap: 15px;
			justify-content: flex-end;
			margin-top: 30px;
		}

		.cancel-btn-modal {
			background: #666;
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 6px;
			font-size: 16px;
			cursor: pointer;
			transition: background-color 0.3s ease;
		}

		.cancel-btn-modal:hover {
			background: #555;
		}

		.save-btn {
			background: #8bc34a;
			color: #000000;
			border: none;
			padding: 12px 24px;
			border-radius: 6px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: background-color 0.3s ease;
		}

		.save-btn:hover {
			background: #7cb342;
		}

		.save-btn:disabled {
			background: #666;
			cursor: not-allowed;
		}

		/* Responsive design */
		@media (max-width: 768px) {
			.dashboard-header {
				flex-direction: column;
				text-align: center;
				gap: 15px;
				padding: 0 20px;
			}

			.dashboard-title {
				font-size: 28px;
			}

			.modal-content {
				width: 95%;
				margin: 10px;
			}

			.form-actions {
				flex-direction: column;
			}
		}
	</style>

	<script>
		// Shared global variables
		let services = [];
		let myServices = [];

		document.addEventListener('DOMContentLoaded', async function () {
			// Check if user is authenticated and is a barber
			const isAuthenticated = await checkUserAuthentication();
			if (!isAuthenticated) {
				window.location.href = '/login';
				return;
			}
		});

		async function checkUserAuthentication() {
			try {
				const response = await fetch('/profile/me', {
					credentials: 'include'
				});

				if (response.ok) {
					const userData = await response.json();
					if (userData.role === 'barber') {
						document.getElementById('welcomeMessage').textContent =
							`Hoş geldiniz, ${userData.name} ${userData.surname}!`;
						return true;
					} else {
						alert('Bu sayfaya erişim yetkiniz yok. Sadece berberler bu paneli kullanabilir.');
						window.location.href = '/';
						return false;
					}
				}
				return false;
			} catch (error) {
				console.error('Authentication check failed:', error);
				return false;
			}
		}
	</script>

<%- include('partials/footer')%>