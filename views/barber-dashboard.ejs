<%- include('partials/header')%>

	<div class="dashboard-container">
		<div class="container-fluid">
			<div class="dashboard-header">
				<h1 class="dashboard-title">Berber Yönetim Paneli</h1>
				<div class="welcome-message">
					<span id="welcomeMessage">Hoş geldiniz!</span>
				</div>
			</div>

			<!-- Appointments Section -->
			<div class="appointments-section">
				<h2 class="section-title">Yaklaşan Randevularım</h2>

				<!-- Loading Spinner -->
				<div id="appointmentsLoading" class="text-center">
					<div class="spinner-border" role="status">
						<span class="sr-only">Yükleniyor...</span>
					</div>
				</div>

				<!-- Error Message -->
				<div id="appointmentsError" class="error-message" style="display: none;"></div>

				<!-- Appointments List -->
				<div id="appointmentsList" class="appointments-list" style="display: none;">
					<!-- Appointments will be inserted here -->
				</div>

				<!-- No Appointments Message -->
				<div id="noAppointments" class="no-appointments" style="display: none;">
					<p>Henüz randevunuz bulunmamaktadır.</p>
				</div>
			</div>

			<!-- Services Section -->
			<div class="services-section">
				<div class="services-header">
					<h2 class="section-title">Aktif Hizmetlerim</h2>
					<button class="add-service-btn" onclick="showAddServiceModal()">Hizmet Ekle</button>
				</div>

				<!-- Loading Spinner for Services -->
				<div id="servicesLoading" class="text-center">
					<div class="spinner-border" role="status">
						<span class="sr-only">Yükleniyor...</span>
					</div>
				</div>

				<!-- Error Message for Services -->
				<div id="servicesError" class="error-message" style="display: none;"></div>

				<!-- Services List -->
				<div id="servicesList" class="services-list" style="display: none;">
					<!-- Services will be inserted here -->
				</div>

				<!-- No Services Message -->
				<div id="noServices" class="no-services" style="display: none;">
					<p>Henüz aktif hizmetiniz bulunmamaktadır.</p>
				</div>
			</div>

			<!-- Add Service Modal -->
			<div id="addServiceModal" class="modal" style="display: none;">
				<div class="modal-content">
					<div class="modal-header">
						<h3>Yeni Hizmet Ekle</h3>
						<span class="close" onclick="hideAddServiceModal()">&times;</span>
					</div>
					<div class="modal-body">
						<form id="addServiceForm">
							<div class="form-group">
								<label for="serviceSelect">Hizmet Seçin:</label>
								<select id="serviceSelect" required>
									<option value="">Hizmet seçiniz...</option>
									<!-- Options will be loaded dynamically -->
								</select>
							</div>
							<div class="form-group">
								<label for="servicePrice">Fiyat (₺):</label>
								<input type="number" id="servicePrice" min="0" step="0.01" required>
							</div>
							<div class="form-group">
								<label for="serviceDuration">Süre (dakika):</label>
								<input type="number" id="serviceDuration" min="1" step="1" required>
							</div>
							<div class="form-actions">
								<button type="button" class="cancel-btn-modal"
									onclick="hideAddServiceModal()">İptal</button>
								<button type="submit" class="save-btn">Hizmeti Ekle</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>

	<style>
		.dashboard-container {
			background-color: #1a1a1a;
			min-height: 100vh;
			padding: 60px 0;
		}

		.dashboard-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 40px;
			padding: 0 40px;
		}

		.dashboard-title {
			color: #8bc34a;
			font-size: 36px;
			font-weight: 600;
			margin: 0;
		}

		.welcome-message {
			color: #ffffff;
			font-size: 18px;
		}

		.appointments-section {
			padding: 0 40px;
		}

		.services-section {
			padding: 0 40px;
			margin-top: 50px;
		}

		.services-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
		}

		.add-service-btn {
			background: #8bc34a;
			color: #000000;
			border: none;
			padding: 12px 24px;
			border-radius: 8px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: background-color 0.3s ease;
		}

		.add-service-btn:hover {
			background: #7cb342;
		}

		/* Modal Styles */
		.modal {
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.8);
			display: flex;
			justify-content: center;
			align-items: center;
		}

		.modal-content {
			background: #2d2d2d;
			border-radius: 12px;
			width: 90%;
			max-width: 500px;
			border: 1px solid #4a4a4a;
		}

		.modal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 20px 25px;
			border-bottom: 1px solid #4a4a4a;
		}

		.modal-header h3 {
			color: #8bc34a;
			margin: 0;
			font-size: 20px;
		}

		.close {
			color: #ffffff;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
			line-height: 1;
		}

		.close:hover {
			color: #8bc34a;
		}

		.modal-body {
			padding: 25px;
		}

		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			color: #ffffff;
			font-weight: 600;
			margin-bottom: 8px;
		}

		.form-group input,
		.form-group select {
			width: 100%;
			padding: 12px;
			border: 1px solid #4a4a4a;
			border-radius: 6px;
			background: #1a1a1a;
			color: #ffffff;
			font-size: 16px;
		}

		.form-group input:focus,
		.form-group select:focus {
			outline: none;
			border-color: #8bc34a;
		}

		.form-actions {
			display: flex;
			gap: 15px;
			justify-content: flex-end;
			margin-top: 30px;
		}

		.cancel-btn-modal {
			background: #666;
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 6px;
			font-size: 16px;
			cursor: pointer;
			transition: background-color 0.3s ease;
		}

		.cancel-btn-modal:hover {
			background: #555;
		}

		.save-btn {
			background: #8bc34a;
			color: #000000;
			border: none;
			padding: 12px 24px;
			border-radius: 6px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: background-color 0.3s ease;
		}

		.save-btn:hover {
			background: #7cb342;
		}

		.save-btn:disabled {
			background: #666;
			cursor: not-allowed;
		}

		.services-list {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
			gap: 20px;
		}

		.service-card {
			background: #2d2d2d;
			border-radius: 12px;
			padding: 20px;
			border: 1px solid #4a4a4a;
			transition: transform 0.3s ease, box-shadow 0.3s ease;
		}

		.service-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
		}

		.service-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
		}

		.service-title {
			color: #8bc34a;
			font-size: 18px;
			font-weight: 600;
		}

		.service-price {
			color: #ffffff;
			font-size: 16px;
			font-weight: 500;
		}

		.service-info {
			display: flex;
			justify-content: space-between;
			align-items: center;
			color: #b0b0b0;
			font-size: 14px;
		}

		.service-duration {
			color: #8bc34a;
		}

		.service-status {
			background: #28a745;
			color: white;
			padding: 4px 8px;
			border-radius: 4px;
			font-size: 12px;
			font-weight: 500;
		}

		.no-services {
			text-align: center;
			padding: 60px 20px;
			color: #b0b0b0;
			font-size: 18px;
		}

		.section-title {
			color: #ffffff;
			font-size: 24px;
			font-weight: 600;
			margin-bottom: 30px;
		}

		.appointments-list {
			display: flex;
			flex-direction: column;
			gap: 20px;
		}

		.appointment-card {
			background: #2d2d2d;
			border-radius: 12px;
			padding: 25px;
			border: 1px solid #4a4a4a;
			transition: transform 0.3s ease, box-shadow 0.3s ease;
		}

		.appointment-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
		}

		.appointment-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
		}

		.customer-name {
			color: #8bc34a;
			font-size: 20px;
			font-weight: 600;
		}

		.appointment-time {
			color: #ffffff;
			font-size: 16px;
			font-weight: 500;
		}

		.appointment-details {
			display: grid;
			grid-template-columns: 1fr 1fr 1fr;
			gap: 20px;
			margin-top: 15px;
		}

		.detail-item {
			color: #b0b0b0;
		}

		.detail-label {
			font-weight: 600;
			color: #ffffff;
			margin-bottom: 5px;
		}

		.service-name {
			color: #8bc34a;
			font-weight: 600;
		}

		.cancel-btn {
			background: #ff4444;
			color: white;
			border: none;
			padding: 8px 16px;
			border-radius: 6px;
			font-size: 14px;
			font-weight: 500;
			cursor: pointer;
			transition: background-color 0.3s ease;
			margin-top: 15px;
		}

		.cancel-btn:hover {
			background: #ff3333;
		}

		.cancel-btn:disabled {
			background: #666;
			cursor: not-allowed;
		}

		.error-message {
			background: #ff4444;
			color: white;
			padding: 15px;
			border-radius: 8px;
			text-align: center;
			margin: 20px 0;
		}

		.no-appointments {
			text-align: center;
			padding: 60px 20px;
			color: #b0b0b0;
			font-size: 18px;
		}

		.spinner-border {
			color: #8bc34a;
		}

		/* Responsive design */
		@media (max-width: 768px) {
			.dashboard-header {
				flex-direction: column;
				text-align: center;
				gap: 15px;
				padding: 0 20px;
			}

			.dashboard-title {
				font-size: 28px;
			}

			.appointments-section,
			.services-section {
				padding: 0 20px;
			}

			.appointment-details {
				grid-template-columns: 1fr;
				gap: 10px;
			}

			.appointment-card {
				padding: 20px;
			}

			.services-list {
				grid-template-columns: 1fr;
			}

			.services-header {
				flex-direction: column;
				gap: 15px;
				align-items: stretch;
			}

			.modal-content {
				width: 95%;
				margin: 10px;
			}

			.form-actions {
				flex-direction: column;
			}
		}
	</style>

	<script>
		let services = [];
		let myServices = [];

		document.addEventListener('DOMContentLoaded', async function () {
			// Check if user is authenticated and is a barber
			const isAuthenticated = await checkUserAuthentication();
			if (!isAuthenticated) {
				window.location.href = '/login';
				return;
			}

			// Fetch barber's appointments and services
			fetchMyAppointments();
			fetchMyServices();
			fetchAllServices();

			// Setup event listeners
			setupEventListeners();
		});

		function setupEventListeners() {
			// Modal click outside to close
			window.onclick = function (event) {
				const modal = document.getElementById('addServiceModal');
				if (event.target === modal) {
					hideAddServiceModal();
				}
			}

			// Form submit handler
			const form = document.getElementById('addServiceForm');
			if (form) {
				form.addEventListener('submit', handleAddServiceSubmit);
			}
		}

		async function handleAddServiceSubmit(e) {
			e.preventDefault();

			const serviceId = document.getElementById('serviceSelect').value;
			const price = parseFloat(document.getElementById('servicePrice').value);
			const duration = parseInt(document.getElementById('serviceDuration').value);

			// Validation
			if (!serviceId) {
				alert('Lütfen bir hizmet seçin');
				return;
			}
			if (!price || price <= 0) {
				alert('Lütfen geçerli bir fiyat girin');
				return;
			}
			if (!duration || duration <= 0) {
				alert('Lütfen geçerli bir süre girin');
				return;
			}

			// Bu kontrole artık gerek yok çünkü dropdown zaten filtrelenmiş hizmetleri gösteriyor
			// Ama güvenlik için bırakabiliriz
			const existingService = myServices.find(s => s.service && s.service._id === serviceId);
			if (existingService) {
				alert('Bu hizmet zaten mevcut');
				return;
			}

			try {
				const response = await fetch('/api/barbers/me/services', {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json'
					},
					credentials: 'include',
					body: JSON.stringify({
						servicesOffered: [{
							service: serviceId,
							price: price,
							duration: duration,
							isActive: true
						}]
					})
				});

				if (response.ok) {
					hideAddServiceModal();
					await fetchMyServices(); // Refresh services list
					alert('Hizmet başarıyla eklendi!');
				} else {
					const error = await response.json();
					throw new Error(error.message || 'Hizmet eklenirken hata oluştu');
				}
			} catch (error) {
				console.error('Error:', error);
				alert('Hizmet eklenirken hata oluştu: ' + error.message);
			}
		}

		async function checkUserAuthentication() {
			try {
				const response = await fetch('/profile/me', {
					credentials: 'include'
				});

				if (response.ok) {
					const userData = await response.json();
					if (userData.role === 'barber') {
						document.getElementById('welcomeMessage').textContent =
							`Hoş geldiniz, ${userData.name} ${userData.surname}!`;
						return true;
					} else {
						alert('Bu sayfaya erişim yetkiniz yok. Sadece berberler bu paneli kullanabilir.');
						window.location.href = '/';
						return false;
					}
				}
				return false;
			} catch (error) {
				console.error('Authentication check failed:', error);
				return false;
			}
		}

		async function fetchAllServices() {
			try {
				const response = await fetch('/api/services');
				if (!response.ok) {
					throw new Error('Hizmetler alınamadı');
				}
				services = await response.json();
				populateServiceDropdown();
			} catch (error) {
				console.error('Error fetching services:', error);
			}
		}

		function populateServiceDropdown() {
			const select = document.getElementById('serviceSelect');
			if (select) {
				select.innerHTML = '<option value="">Hizmet seçiniz...</option>';

				// Berberin zaten eklediği hizmetlerin ID'lerini al
				const addedServiceIds = myServices.map(serviceOffered =>
					serviceOffered.service ? serviceOffered.service._id : null
				).filter(id => id !== null);

				// Sadece henüz eklenmemiş hizmetleri göster
				const availableServices = services.filter(service =>
					!addedServiceIds.includes(service._id)
				);

				if (availableServices.length === 0) {
					const option = document.createElement('option');
					option.value = '';
					option.textContent = 'Eklenebilecek hizmet bulunmuyor';
					option.disabled = true;
					select.appendChild(option);
				} else {
					availableServices.forEach(service => {
						const option = document.createElement('option');
						option.value = service._id;
						option.textContent = service.name;
						select.appendChild(option);
					});
				}
			}
		}

		async function fetchMyAppointments() {
			const loading = document.getElementById('appointmentsLoading');
			const errorMessage = document.getElementById('appointmentsError');
			const appointmentsList = document.getElementById('appointmentsList');
			const noAppointments = document.getElementById('noAppointments');

			try {
				const response = await fetch('/api/appointments/my-appointments', {
					credentials: 'include'
				});

				loading.style.display = 'none';

				if (response.ok) {
					const appointments = await response.json();

					if (appointments.length > 0) {
						appointmentsList.style.display = 'block';
						renderAppointments(appointments);
					} else {
						noAppointments.style.display = 'block';
					}
				} else if (response.status === 401) {
					window.location.href = '/login';
				} else {
					errorMessage.textContent = 'Randevular yüklenirken bir hata oluştu.';
					errorMessage.style.display = 'block';
				}
			} catch (error) {
				loading.style.display = 'none';
				errorMessage.textContent = 'Randevular yüklenirken bir hata oluştu.';
				errorMessage.style.display = 'block';
				console.error('Error fetching appointments:', error);
			}
		}

		function renderAppointments(appointments) {
			const appointmentsList = document.getElementById('appointmentsList');
			appointmentsList.innerHTML = '';

			appointments.forEach(appointment => {
				const appointmentDate = new Date(appointment.startTime);
				const formattedDate = appointmentDate.toLocaleDateString('tr-TR', {
					day: 'numeric',
					month: 'long',
					year: 'numeric'
				});
				const formattedTime = appointmentDate.toLocaleTimeString('tr-TR', {
					hour: '2-digit',
					minute: '2-digit'
				});

				const appointmentCard = document.createElement('div');
				appointmentCard.className = 'appointment-card';
				appointmentCard.innerHTML = `
                <div class="appointment-header">
                    <div class="customer-name">${appointment.customer.name} ${appointment.customer.surname}</div>
                    <div class="appointment-time">${formattedDate} - ${formattedTime}</div>
                </div>
                <div class="appointment-details">
                    <div class="detail-item">
                        <div class="detail-label">Hizmet:</div>
                        <div class="service-name">${appointment.service.name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Süre:</div>
                        <div>${appointment.service.duration} dakika</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Durum:</div>
                        <div>Planlandı</div>
                    </div>
                </div>
                <button class="cancel-btn" onclick="cancelAppointment('${appointment._id}')" id="cancel-${appointment._id}">
                    Randevuyu İptal Et
                </button>
            `;

				appointmentsList.appendChild(appointmentCard);
			});
		}

		async function cancelAppointment(appointmentId) {
			const cancelBtn = document.getElementById(`cancel-${appointmentId}`);

			if (!confirm('Bu randevuyu iptal etmek istediğinizden emin misiniz?')) {
				return;
			}

			// Disable button during request
			cancelBtn.disabled = true;
			cancelBtn.textContent = 'İptal ediliyor...';

			try {
				const response = await fetch(`/api/appointments/${appointmentId}`, {
					method: 'DELETE',
					credentials: 'include'
				});

				if (response.ok) {
					// Remove the appointment card from the UI
					const appointmentCard = cancelBtn.closest('.appointment-card');
					appointmentCard.remove();

					// Check if there are any appointments left
					const remainingAppointments = document.querySelectorAll('.appointment-card');
					if (remainingAppointments.length === 0) {
						document.getElementById('appointmentsList').style.display = 'none';
						document.getElementById('noAppointments').style.display = 'block';
					}

					alert('Randevu başarıyla iptal edildi.');
				} else {
					const errorData = await response.json();
					alert('Randevu iptal edilirken hata oluştu: ' + (errorData.message || 'Bilinmeyen hata'));

					// Re-enable button on error
					cancelBtn.disabled = false;
					cancelBtn.textContent = 'Randevuyu İptal Et';
				}
			} catch (error) {
				console.error('Error canceling appointment:', error);
				alert('Randevu iptal edilirken bir hata oluştu.');

				// Re-enable button on error
				cancelBtn.disabled = false;
				cancelBtn.textContent = 'Randevuyu İptal Et';
			}
		}

		async function fetchMyServices() {
			const loading = document.getElementById('servicesLoading');
			const errorMessage = document.getElementById('servicesError');
			const servicesList = document.getElementById('servicesList');
			const noServices = document.getElementById('noServices');

			try {
				const response = await fetch('/api/barbers/me/services', {
					credentials: 'include'
				});

				loading.style.display = 'none';

				if (response.ok) {
					const servicesData = await response.json();
					myServices = servicesData;

					if (servicesData.length > 0) {
						servicesList.style.display = 'grid';
						renderServices(servicesData);
					} else {
						noServices.style.display = 'block';
					}

					// Dropdown'u güncelle (mevcut hizmetler değiştiği için)
					populateServiceDropdown();
				} else if (response.status === 401) {
					window.location.href = '/login';
				} else {
					errorMessage.textContent = 'Hizmetler yüklenirken bir hata oluştu.';
					errorMessage.style.display = 'block';
				}
			} catch (error) {
				loading.style.display = 'none';
				errorMessage.textContent = 'Hizmetler yüklenirken bir hata oluştu.';
				errorMessage.style.display = 'block';
				console.error('Error fetching services:', error);
			}
		}

		function renderServices(services) {
			const servicesList = document.getElementById('servicesList');
			servicesList.innerHTML = '';

			services.forEach(serviceOffered => {
				const service = serviceOffered.service; // Populated service data

				const serviceCard = document.createElement('div');
				serviceCard.className = 'service-card';
				serviceCard.innerHTML = `
					<div class="service-header">
						<div class="service-title">${service.name}</div>
						<div class="service-price">${serviceOffered.price}₺</div>
					</div>
					<div class="service-info">
						<div class="service-duration">${serviceOffered.duration} dakika</div>
						<div class="service-status">Aktif</div>
					</div>
				`;

				servicesList.appendChild(serviceCard);
			});
		}

		function showAddServiceModal() {
			document.getElementById('addServiceModal').style.display = 'block';
			document.body.style.overflow = 'hidden';
		}

		function hideAddServiceModal() {
			document.getElementById('addServiceModal').style.display = 'none';
			document.body.style.overflow = 'auto';
			// Reset form
			document.getElementById('addServiceForm').reset();
		}
	</script>

	<%- include('partials/footer')%>